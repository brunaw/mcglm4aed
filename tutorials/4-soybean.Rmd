---
title: "Water and potassium on the production of soybean"
author: |
  | Wagner H. Bonat   | Walmes M. Zeviani |
  |:-----------------:|:-----------------:|
  | `wbonat@ufpr.br`  | `walmes@ufpr.br`  |
date: >
  63^a^ RBras & 17^o^ SEAGRO</br>
  July 24--28, 2017</br>
  UFLA, Lavras/MG
bibliography: ../slides/config/ref.bib
---

```{r, include = FALSE}
source("../slides/config/_setup.R")
```

# Data description and objectives

The tropical soils, usually poor in potassium (K), demand potassium
fertilization when cultivated with soybean (*Glycine max* L.) to obtain
satisfactory yields. The aim of this study was to evaluate the effects
of K doses (`pts`) and soil humidity (`wtr`) levels on soybean agronomic
characteristics.

The experiment was carried out in a greenhouse, in pots with two plants,
containing 5 dm^3^ of soil. The experimental design was completely
randomized block with treatments in a 5 $\times$ 3 factorial
arrangement. The K doses were 0; 30; 60, 120 and 180 mg dm^-3^ and the
soil humidity ranged from 35 to 40; 47.5 to 52.5; and 60 to 65% of the
total porosity. The responses measured were: grain yield
(`yield`), weight of a hundred grains (`w100`), total number of grains
per pot (`tg`), K level in the grain (`Kconc`), number of viable pods
(`nvp`, `nip` is the inviable pods).

For more information, see @Serafim2012.

```{r}
#-----------------------------------------------------------------------
# Packages.

rm(list = ls())
library(lattice)
library(latticeExtra)
library(car)
library(candisc)
library(corrplot)
```

# MLM for the soybean dataset

```{r}
#-----------------------------------------------------------------------
# Multivariate analysis of the soybean dataset.

# Visit to see the online documentation:
# https://github.com/walmes/wzRfun/blob/master/R/wzRfun.R#L10.

data(soybeanwp, package = "wzRfun")
str(soybeanwp)
head(soybeanwp)

# A copy with shorter names.
swp <- soybeanwp
# dput(names(swp))
names(swp) <- c("pts", "wtr", "blk",
                "yield", "w100", "Kconc", "tg", "nip", "nvp")

# Convert the controled numeric factors to categorical factors.
swp <- transform(swp,
                 Pts = factor(pts),
                 Wtr = factor(wtr))

# Creates the proportion of viable pods.
swp$pvp <- with(swp, nvp/(nvp + nip))
str(swp)

#-----------------------------------------------------------------------
# Data visulization.

# The 74 observation is an outlier to yield and tg.

combineLimits(
    useOuterStrips(
        xyplot(yield + tg + w100 + Kconc + pvp ~ pts | Wtr,
               outer = TRUE,
               as.table = TRUE,
               # data = swp[-74, ],
               data = swp,
               pch = 19,
               xlab = "Potassium",
               ylab = "Values",
               scales = list(y = "free"),
               groups = blk))) +
    layer(panel.xyplot(x = x, y = y, type = "a", col = 1))

#-----------------------------------------------------------------------
# Potassium 0.

summary(swp)

#--------------------------------------------
# Condition 1: no sufficient evidence in each response.

options(show.signif.stars = FALSE)

xyplot(yield + tg + w100 + Kconc ~ Wtr,
       outer = TRUE, scales = "free",
       data = subset(swp[-74, ], pts == 0))

form <- cbind(yield, tg, w100, Kconc) ~ blk + Wtr

# Rare condictions ().
m0 <- lm(form, data = subset(swp[-74, ], pts == 0))
summary.aov(m0)

# anova(m0, test = "Roy")

#--------------------------------------------
# Condition 2: all the conclusions are quite the same.

xyplot(yield + tg + w100 + Kconc ~ Wtr,
       outer = TRUE, scales = "free",
       data = subset(swp[-74, ], pts == 60))

m0 <- lm(form, data = subset(swp[-74, ], pts == 60))
summary.aov(m0)

library(doBy)
library(multcomp)

tb <- lapply(c("yield", "tg", "w100", "Kconc"),
             FUN = function(y) {
                 m0 <- lm(as.formula(sprintf("%s ~ blk + Wtr", y)),
                          data = subset(swp[-74, ], pts == 60))
                 m <- LSmeans(m0, effect = "Wtr")
                 g <- glht(model = m0, linfct = mcp(Wtr = "Tukey"))
                 g <- cld(g)$mcletters$Letters
                 r <- data.frame(Wtr = m$grid$Wtr,
                                 means = sprintf("%0.2f %s",
                                                 m$coef[, "estimate"],
                                                 g[as.character(m$grid$Wtr)]))
                 names(r)[2] <- y
                 return(r)
             })

# Table of means.
tbm <- Reduce(merge, x = tb)
tbm

#-----------------------------------------------------------------------
# Fitting the multivariate Gaussian linear model.

m0 <- lm(cbind(yield, tg, w100, Kconc, pvp) ~ blk + Wtr * Pts,
         data = swp[-74, ])

# MANOVA.
anova(m0)

# ANOVAs.
summary.aov(m0)

# Univariate model summaries.
# summary(m0)

# Estimated parameter.
coef(m0)

# Raw residuals.
r <- residuals(m0)
var(r)
cor(r)

# Change the 3rd color of the palette used for the ellipses.
oldpal <- palette()
palette(c("black", "blue", "red"))
scatterplotMatrix(r,
                  gap = 0,
                  smooth = FALSE,
                  reg.line = FALSE,
                  ellipse = TRUE,
                  diagonal = "qqplot")
palette(oldpal)

corrplot(cor(r),
         type = "upper",
         tl.pos = "d",
         outline = TRUE,
         method = "ellipse")

#-----------------------------------------------------------------------
# Canonical analysis.

cd_WP <- candisc(m0, term = "Wtr:Pts")
cd_WP
cd_WP$coeffs.raw
head(cd_WP$scores)
plot(cd_WP)

cd_P <- candisc(m0, term = "Pts")
cd_P
cd_P$coeffs.raw
head(cd_P$scores)
plot(cd_P)

cd_W <- candisc(m0, term = "Wtr")
cd_W
cd_W$coeffs.raw
head(cd_W$scores)
plot(cd_W)
```

```{r eval = FALSE, include = FALSE}
#-----------------------------------------------------------------------
# ATTENTION: code in tests.

# full <- cbind(yield, tg, w100, Kconc, pvp) ~ blk + Wtr * Pts
# null <- . ~ blk + Wtr + Pts
# data <- swp[-74, ]

gugudada <- function(full, null, data) {
    # Nested models.
    m_full <- lm(full, data)
    m_null <- update(m_full, null)
    # SSP.
    S_full <- crossprod(residuals(m_full))
    S_null <- crossprod(residuals(m_null))
    S_extr <- S_null - S_full
    # Eigen decomposition.
    ei <- eigen(solve(S_full, S_extr))
    print(ei)
    scores <- as.matrix(m_full$model[1]) %*% ei$vectors[, 1:2]
    plot(scores, asp = 1)
    print(anova(update(m_full, scores[, 1] ~ .)))
    print(anova(update(m_full, scores[, 2] ~ .)))
}

# Effect of interaction.
par(mfrow = c(1, 2))
plot(cd_WP)
grid()
gugudada(full = cbind(yield, tg, w100, Kconc, pvp) ~ blk + Wtr * Pts,
         null = . ~ blk + Wtr + Pts,
         data = swp[-74, ])
grid()
layout(1)

# Effect of Wtr.
par(mfrow = c(1, 2))
plot(cd_W)
grid()
gugudada(full = cbind(yield, tg, w100, Kconc, pvp) ~ blk + Pts + Wtr,
         null = . ~ blk + Pts,
         data = swp[-74, ])
grid()
layout(1)

# ATTENTION: This requires more study to fully understand.
#-----------------------------------------------------------------------
```

# References

<!-- Insert the refereces right here! -->
<div id="refs">
</div>

# Session information

```{r}
# devtools::session_info()
Sys.time()
cbind(Sys.info())
sessionInfo()
```
